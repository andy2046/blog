# [React] Redux æºç è§£è¯»

![redux](https://user-images.githubusercontent.com/2193706/36338194-8c1a5dca-13e3-11e8-85c0-d45c030a9de8.jpg)

---

![redux work flow](https://user-images.githubusercontent.com/2193706/36338195-96d490be-13e3-11e8-9a95-e18fba4e3c71.png)
---

# ä»‹ç»
æˆ‘ä»¬ä¸€èµ·æ¥ç ”ç©¶ä¸‹å½“å‰æœ€æµè¡Œçš„**ReactçŠ¶æ€ç®¡ç†å®¹å™¨Redux**ï¼Œæœ¬æ–‡åŸºäº**Redux v3.7.2** ï¼ŒReduxç”¨ä¸€ä¸ªå•ç‹¬çš„çŠ¶æ€æ ‘å¯¹è±¡ï¼ˆstate tree objectï¼‰ä¿å­˜æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€ï¼Œè¿™ä¸ªå¯¹è±¡ä¸èƒ½ç›´æ¥è¢«æ”¹å˜ï¼ˆimmutableï¼‰ï¼Œå½“æ•°æ®å˜åŒ–äº†ï¼Œä¸€ä¸ªæ–°çš„å¯¹è±¡å°±ä¼šè¢«åˆ›å»ºï¼ˆé€šè¿‡actionså’Œreducersï¼‰

Reduxæœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š
- å¯é¢„æµ‹
å§‹ç»ˆæœ‰ä¸€ä¸ªå”¯ä¸€çš„å‡†ç¡®çš„æ•°æ®æºï¼ˆsingle source of truthï¼‰ï¼Œå°±æ˜¯storeï¼Œé€šè¿‡actionså’Œreducersæ¥ä¿è¯æ•´ä¸ªåº”ç”¨çŠ¶æ€åŒæ­¥ï¼Œåšåˆ°ç»ä¸æ··ä¹±
- æ˜“ç»´æŠ¤
å…·å¤‡å¯é¢„æµ‹çš„ç»“æœå’Œä¸¥æ ¼çš„ç»„ç»‡ç»“æ„è®©ä»£ç æ›´å®¹æ˜“ç»´æŠ¤
- æ˜“æµ‹è¯•
ç¼–å†™å¯æµ‹è¯•ä»£ç çš„é¦–è¦å‡†åˆ™æ˜¯ç¼–å†™å¯ä»¥ä»…åšä¸€ä»¶äº‹å¹¶ä¸”ç‹¬ç«‹çš„å°å‡½æ•°ï¼ˆsingle responsibility principleï¼‰ï¼ŒReduxçš„ä»£ç å‡ ä¹å…¨éƒ¨éƒ½æ˜¯è¿™æ ·çš„å‡½æ•°ï¼šçŸ­å°Â·çº¯ç²¹Â·åˆ†ç¦»

# å®ä¾‹ä»£ç 
ä¸¾ä¸ªå°æ —å­ğŸŒ°çœ‹çœ‹åº”ç”¨ä»£ç ä¸­å¦‚ä½•ä½¿ç”¨Redux
ä¾‹å­å–è‡ªRedux examples é‡Œé¢çš„counter
```js
import React           from 'react'
import ReactDOM        from 'react-dom'
import { createStore } from 'redux'
import Counter         from './components/Counter'
// import counter      from './reducers'
const counter = (state = 0, action) => {
  switch (action.type) {
    case 'INCREMENT':
      return state + 1
    case 'DECREMENT':
      return state - 1
    default:
      return state
  }
}

const store = createStore(counter)
const rootEl = document.getElementById('root')

const render = () => ReactDOM.render(
  <Counter
    value={store.getState()}
    onIncrement={() => store.dispatch({ type: 'INCREMENT' })}
    onDecrement={() => store.dispatch({ type: 'DECREMENT' })}
  />,
  rootEl
)

render()
store.subscribe(render)
```

# æ•´ä½“ç»“æ„
![redux source code structure](https://user-images.githubusercontent.com/2193706/36338320-b8a938fe-13e6-11e8-9f2b-5fad07d431d5.png)

## utils/warning.js
utilsç›®å½•ä¸‹é¢çš„warning.jsè´Ÿè´£æ§åˆ¶å°é”™è¯¯æ—¥å¿—çš„è¾“å‡ºï¼Œç”¨äºéç”Ÿäº§ç¯å¢ƒä¸‹ï¼ˆ`process.env.NODE_ENV !== 'production'`ï¼‰æŠ›å‡ºé”™è¯¯ä¾¿äºdebugï¼š
```js
export default function warning(message) {
  if (typeof console !== 'undefined' && typeof console.error === 'function') {
    console.error(message)
  }
  try {
    // This error was thrown as a convenience so that if you enable
    // "break on all exceptions" in your console,
    // it would pause the execution at this line.
    throw new Error(message)
  } catch (e) { }
}
```

## index.js
å…¥å£æ–‡ä»¶index.jsä¸»è¦ç”¨äºå¼•å‡ºå…¬å…±æ–¹æ³•APIä¾›å¤–é¢è°ƒç”¨ï¼ŒisCrushedé‚£æ®µç”¨äºéç”Ÿäº§ç¯å¢ƒ
```js
import createStore from './createStore'
import combineReducers from './combineReducers'
import bindActionCreators from './bindActionCreators'
import applyMiddleware from './applyMiddleware'
import compose from './compose'
import warning from './utils/warning'

function isCrushed() {}

if (
  process.env.NODE_ENV !== 'production' &&
  typeof isCrushed.name === 'string' &&
  isCrushed.name !== 'isCrushed'
) {
  warning(
    'You are currently using minified code outside of NODE_ENV === \'production\'. ' +
    'This means that you are running a slower development build of Redux. ' +
    'You can use loose-envify (https://github.com/zertosh/loose-envify) for browserify ' +
    'or DefinePlugin for webpack (http://stackoverflow.com/questions/30030031) ' +
    'to ensure you have the correct code for your production build.'
  )
}

export {
  createStore,
  combineReducers,
  bindActionCreators,
  applyMiddleware,
  compose
}
```

## createStore.js
createStore.jsç”¨äºStoreçš„ç”Ÿæˆï¼Œæ¥å—3ä¸ªå‚æ•°ï¼š
- reducerå‡½æ•°ï¼Œæ¥å—å½“å‰state treeå’Œä¸€ä¸ªactionï¼Œè¿”å›æ–°çš„state tree
- preloadedStateï¼Œåˆå§‹çŠ¶æ€æ ‘ï¼Œå¦‚æœä½ ä½¿ç”¨`combineReducers`ï¼Œå¿…é¡»ç¡®ä¿åˆå§‹state tree objectçš„keyså’Œ`combineReducers`çš„keysä¿æŒä¸€è‡´
- enhancerï¼Œç”¨æ¥å¼ºåŒ–storeï¼Œæ¯”å¦‚middleware ï¼ time travelï¼ŒReduxè‡ªå¸¦çš„å”¯ä¸€enhanceræ˜¯`applyMiddleware()`

#### getState()
ç”¨æ¥è¿”å›å½“å‰state tree
#### replaceReducer(nextReducer)
ç”¨æ¥æ›¿æ¢æ‰å½“å‰storeç”¨çš„reducerï¼Œå¯ç”¨äºåŠ¨æ€æŒ‰éœ€åŠ è½½æˆ–è€…çƒ­æ›¿æ¢ç­‰åœºæ™¯

#### subscribe(listener)
è®¢é˜…å‡½æ•°ï¼Œç”¨æ¥æ³¨å†Œç›‘å¬äº‹ä»¶ï¼Œå¹¶è¿”å›å–æ¶ˆè®¢é˜…çš„å‡½æ•°
æ¯å½“dispatchä¸€ä¸ªactionæ—¶æ³¨å†Œçš„listenerè¢«è°ƒç”¨ï¼Œä¸ºå®ç°å®æ—¶æ€§ï¼Œç›‘å¬å‡½æ•°listeneråŠ å…¥åˆ°nextListenersæ•°ç»„ä¸­ï¼Œè€Œdispatchäº‹ä»¶ä½¿ç”¨currentListenersæ•°ç»„

#### dispatch(action)
ç”¨æ¥åˆ†å‘actionä¿®æ”¹state treeçš„å”¯ä¸€æ–¹å¼ï¼Œactionå¿…é¡»æ˜¯plain objectå¹¶å¸¦æœ‰typeå±æ€§
- å°†å½“å‰state treeå’Œactionä¼ å…¥Reducerï¼Œè¿”å›çš„æ–°çš„state treeç”¨äºæ›´æ–°å½“å‰state tree
- æŒ‰é¡ºåºè°ƒç”¨currentListenersæ•°ç»„ä¸­çš„listener
- è¿”å›action

#### observable()
ç”¨äºä¸`observable/reactive lib`äº’æ“ä½œï¼Œå½“dispatchä¸€ä¸ªactionæ—¶ï¼Œè°ƒç”¨æ³¨å†Œçš„observerçš„nextæ–¹æ³•

```js
import isPlainObject from 'lodash/isPlainObject'
import $$observable from 'symbol-observable'

export const ActionTypes = {
  INIT: '@@redux/INIT'
}

export default function createStore(reducer, preloadedState, enhancer) {
  if (typeof preloadedState === 'function' && typeof enhancer === 'undefined') {
    enhancer = preloadedState
    preloadedState = undefined
  }
  if (typeof enhancer !== 'undefined') {
    if (typeof enhancer !== 'function') {
      throw new Error('Expected the enhancer to be a function.')
    }
    return enhancer(createStore)(reducer, preloadedState)
  }
  if (typeof reducer !== 'function') {
    throw new Error('Expected the reducer to be a function.')
  }

  let currentReducer = reducer
  let currentState = preloadedState
  let currentListeners = []
  let nextListeners = currentListeners
  let isDispatching = false

  function ensureCanMutateNextListeners() {
    if (nextListeners === currentListeners) {
      nextListeners = currentListeners.slice()
    }
  }

  function getState() {
    return currentState
  }

  function subscribe(listener) {
    if (typeof listener !== 'function') {
      throw new Error('Expected listener to be a function.')
    }
    let isSubscribed = true
    ensureCanMutateNextListeners()
    nextListeners.push(listener)
    return function unsubscribe() {
      if (!isSubscribed) {
        return
      }
      isSubscribed = false
      ensureCanMutateNextListeners()
      const index = nextListeners.indexOf(listener)
      nextListeners.splice(index, 1)
    }
  }

  function dispatch(action) {
    if (!isPlainObject(action)) {
      throw new Error(
        'Actions must be plain objects. ' +
        'Use custom middleware for async actions.'
      )
    }
    if (typeof action.type === 'undefined') {
      throw new Error(
        'Actions may not have an undefined "type" property. ' +
        'Have you misspelled a constant?'
      )
    }
    if (isDispatching) {
      throw new Error('Reducers may not dispatch actions.')
    }
    try {
      isDispatching = true
      currentState = currentReducer(currentState, action)
    } finally {
      isDispatching = false
    }
    const listeners = currentListeners = nextListeners
    for (let i = 0; i < listeners.length; i++) {
      const listener = listeners[i]
      listener()
    }
    return action
  }

  function replaceReducer(nextReducer) {
    if (typeof nextReducer !== 'function') {
      throw new Error('Expected the nextReducer to be a function.')
    }
    currentReducer = nextReducer
    dispatch({ type: ActionTypes.INIT })
  }

  function observable() {
    const outerSubscribe = subscribe
    return {
      subscribe(observer) {
        if (typeof observer !== 'object') {
          throw new TypeError('Expected the observer to be an object.')
        }
        function observeState() {
          if (observer.next) {
            observer.next(getState())
          }
        }
        observeState()
        const unsubscribe = outerSubscribe(observeState)
        return { unsubscribe }
      },
      [$$observable]() {
        return this
      }
    }
  }

  dispatch({ type: ActionTypes.INIT })

  return {
    dispatch,
    subscribe,
    getState,
    replaceReducer,
    [$$observable]: observable
  }
}
```

## bindActionCreators.js
å°†action creatorsè½¬æ¢æˆå…·æœ‰åŒåkeysçš„å¯¹è±¡ï¼Œç”¨dispatchæŠŠæ¯ä¸ªaction creatoråŒ…èµ·æ¥ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨å®ƒä»¬ï¼Œå°†åŒ…å¥½çš„action creatorå¾€ä¸‹ä¼ åˆ°ä¸€ä¸ªç»„ä»¶ä¸Šï¼Œå´ä¸è®©è¿™ä¸ªç»„ä»¶è§‰å¯Ÿåˆ°Reduxçš„å­˜åœ¨ï¼Œæ¾è€¦åˆ
```js
function bindActionCreator(actionCreator, dispatch) {
  return (...args) => dispatch(actionCreator(...args))
}

export default function bindActionCreators(actionCreators, dispatch) {
  if (typeof actionCreators === 'function') {
    return bindActionCreator(actionCreators, dispatch)
  }

  if (typeof actionCreators !== 'object' || actionCreators === null) {
    throw new Error(
      `bindActionCreators expected an object or a function, instead received ${actionCreators === null ? 'null' : typeof actionCreators}. ` +
      `Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`
    )
  }

  const keys = Object.keys(actionCreators)
  const boundActionCreators = {}
  for (let i = 0; i < keys.length; i++) {
    const key = keys[i]
    const actionCreator = actionCreators[key]
    if (typeof actionCreator === 'function') {
      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)
    }
  }
  return boundActionCreators
}
```

## combineReducers.js
ç”¨æ¥åˆå¹¶Reducersï¼Œå°†å¤šä¸ªReducerå‡½æ•°æ„æˆçš„å¯¹è±¡è½¬æ¢ä¸ºå•ä¸ªReducerå‡½æ•°ï¼Œå½“åº”ç”¨è¾ƒå¤§æ—¶Reducerså¯ä»¥æŒ‰ç…§æ¨¡å—æ‹†åˆ†ï¼ˆdomain model && SRPï¼‰ï¼Œä»£ç ç»“æ„æ¯”è¾ƒæ¸…æ™°ï¼Œå®ƒä¼šè°ƒç”¨æ¯ä¸ªå­Reducerï¼Œå¹¶æ”¶é›†ç»“æœç»„æˆä¸€ä¸ªå•ä¸€çš„state tree objectï¼Œå…¶keysä¸ä¼ é€’çš„å­Reducerçš„keysç›¸å¯¹åº”
å¯¹æ¯ä¸€ä¸ªReducerï¼Œå…¶åˆå§‹stateä¸å¯ä»¥ä¸ºundefinedï¼Œä½†å¯ä»¥ä¸ºnullï¼Œå¯¹ä¼ å…¥çš„actionï¼Œå¦‚æœactionä¸ºundefinedï¼Œåº”è¯¥è¿”å›åˆå§‹stateï¼Œå¦‚æœæ˜¯æœªçŸ¥çš„actionï¼Œåº”è¯¥è¿”å›å½“å‰state
```js
export default function combineReducers(reducers) {
  const reducerKeys = Object.keys(reducers)
  const finalReducers = {}
  for (let i = 0; i < reducerKeys.length; i++) {
    const key = reducerKeys[i]
    if (typeof reducers[key] === 'function') {
      finalReducers[key] = reducers[key]
    }
  }
  const finalReducerKeys = Object.keys(finalReducers)
  let shapeAssertionError
  try {
    assertReducerShape(finalReducers)
  } catch (e) {
    shapeAssertionError = e
  }

  return function combination(state = {}, action) {
    if (shapeAssertionError) {
      throw shapeAssertionError
    }
    let hasChanged = false
    const nextState = {}
    for (let i = 0; i < finalReducerKeys.length; i++) {
      const key = finalReducerKeys[i]
      const reducer = finalReducers[key]
      const previousStateForKey = state[key]
      const nextStateForKey = reducer(previousStateForKey, action)
      if (typeof nextStateForKey === 'undefined') {
        const errorMessage = getUndefinedStateErrorMessage(key, action)
        throw new Error(errorMessage)
      }
      nextState[key] = nextStateForKey
      hasChanged = hasChanged || nextStateForKey !== previousStateForKey
    }
    return hasChanged ? nextState : state
  }
}
```

## compose.js
ç”¨æ¥ç»„åˆä¼ å…¥çš„å¤šä¸ªå‡½æ•°ï¼Œåœ¨ä¸­é—´ä»¶æ—¶ä¼šç”¨åˆ°ï¼Œæœ€ç»ˆç»“æœæ˜¯æŠŠå„ä¸ªå‡½æ•°ä»å³è‡³å·¦ä¸²è”èµ·æ¥ï¼Œç›¸å½“äºï¼š
`compose(a,b) = (...args) => a(b(...args))`
```js
export default function compose(...funcs) {
  if (funcs.length === 0) {
    return arg => arg
  }
  if (funcs.length === 1) {
    return funcs[0]
  }
  return funcs.reduce((a, b) => (...args) => a(b(...args)))
}
```

## applyMiddleware.js
ç”¨äºå¼ºåŒ–Store
ä¸Šé¢ğŸ‘†åˆ†æcreateStore.jsæˆ‘ä»¬çŸ¥é“ï¼Œä¸­é—´ä»¶å¯ä»¥ä½œä¸ºcreateStoreçš„ç¬¬äºŒä¸ªæˆ–è€…ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥ï¼Œå¦‚æœæœ‰ä¸­é—´ä»¶ï¼Œæ‰§è¡Œç»“æœç›¸å½“äº`applyMiddleware(â€¦middlewares)(createStore)(reducer, preloadedState)`

```js
const store = createStore(reducer,applyMiddleware(â€¦middlewares))
// or
const store = createStore(reducer,{},applyMiddleware(â€¦middlewares))

export default function createStore(reducer, preloadedState, enhancer) {
  if (typeof preloadedState === 'function' && typeof enhancer === 'undefined') {
    enhancer = preloadedState
    preloadedState = undefined
  }

  if (typeof enhancer !== 'undefined') {
    if (typeof enhancer !== 'function') {
      throw new Error('Expected the enhancer to be a function.')
    }

    return enhancer(createStore)(reducer, preloadedState)
  }
}
```
ä»ä¸‹é¢ğŸ‘‡çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç›¸å½“äºç”¨composeæŠŠå„ä¸ªmiddlewareä¸²è”èµ·æ¥ï¼Œä¼ å…¥dispatchå¾—åˆ°æ›´æ–°çš„dispatch
ä¸ºäº†ä¸²è”æ‰€æœ‰middlewareï¼Œå…¶æ¥å—ä¸‰å±‚å‚æ•°ï¼Œç¬¬ä¸€å±‚æ˜¯Storeï¼Œç¬¬äºŒå±‚æ˜¯ä¸‹ä¸€ä¸ªmiddlewareï¼Œç¬¬ä¸‰å±‚æ‰æ˜¯actionï¼Œä»£ç å¦‚ä¸‹ï¼š
```js
export function middleware({ dispatch, getState }) {
  return next => action =>
     { return next(action) }
}
// or
export function createMiddleware() {
  return ({ dispatch, getState }) => next => action =>
    { return next(action) }
}
```
é—®ï¼š`middlewareAPI`ä¸­çš„`dispatch`ä¸ºä½•ç”¨åŒ¿åå‡½æ•°åŒ…èµ·æ¥ï¼Ÿ
ç­”ï¼šç»è¿‡`applyMiddleware()`ä¹‹åçš„`dispatch`æ˜¯æ›´æ–°è¿‡çš„ï¼ŒåŒ…èµ·æ¥åï¼Œåªè¦`dispatch`æ›´æ–°ï¼Œ`middlewareAPI`ä¸­çš„`dispatch`ä¹Ÿä¼šå˜åŒ–

ä¸¾ä¸ªæ —å­ğŸŒ°ï¼Œ"è‡­åæ˜­è‘—"çš„`Thunk`
```js
function createThunkMiddleware(extraArgument) {
  return ({ dispatch, getState }) => next => action => {
    if (typeof action === 'function') {
      return action(dispatch, getState, extraArgument);
    }
    return next(action);
  };
}
const thunk = createThunkMiddleware();
thunk.withExtraArgument = createThunkMiddleware;
export default thunk;
```

```js
export default function applyMiddleware(...middlewares) {
  return (createStore) => (reducer, preloadedState, enhancer) => {
    const store = createStore(reducer, preloadedState, enhancer)
    let dispatch = store.dispatch
    let chain = []

    const middlewareAPI = {
      getState: store.getState,
      dispatch: (action) => dispatch(action)
    }
    chain = middlewares.map(middleware => middleware(middlewareAPI))
    dispatch = compose(...chain)(store.dispatch)

    return {
      ...store,
      dispatch
    }
  }
}
```

[GitHub repo for Redux](https://github.com/reactjs/redux)
